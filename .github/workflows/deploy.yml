name: ðŸš€ Deploy Carton Planner to DigitalOcean

on:
  push:
    branches:
      - main  # change if you deploy from another branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¦ Sync files to droplet
        run: |
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='api/config.php' \
            ./ \
            ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }}:/var/www/carton-planner

      - name: ðŸ”‘ Write Mailgun config
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} "cat > /var/www/carton-planner/api/config.php << 'EOFCONFIG'
          <?php
          define('MAILGUN_API_KEY', '${{ secrets.MAILGUN_API_KEY }}');
          define('MAILGUN_DOMAIN', 'mg.e-bedding.co.uk');
          define('MAILGUN_TO_EMAIL', 'stephen.collins@comfygroup.co.uk');
          EOFCONFIG"

      - name: ðŸ”„ Restart Nginx
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} "systemctl restart nginx"

      - name: âœ… Verify Deployment
        run: |
          curl -I https://${{ secrets.DO_HOST }}
